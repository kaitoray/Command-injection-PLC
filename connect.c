/* connect.c
it is used to connect PLC
*/
#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define _CRT_NONSTDC_NO_WARNINGS
#define  _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>
#include <windows.h>     /* Note: winsock2.h has included windows.h */
#include <conio.h>  //Include keyboard listening function kbhit()
#include <time.h>
#include "reference.h"
#include "message.h"
#include "commands.h"

SOCKET        HMI007;   /* defined in winsock2.h */
byte sendMessageStr[100], SN1, SN2, SN3, SN4; /* message to be sent to server */
char  recvBuffer[100], input=0;
int sendStatus, recvStatus, i;

int main(void)
{
	WSADATA       wsa_data;           /* defined in winsock2.h */
	struct sockaddr_in HMI;     /* defined in winsock2.h */
	struct hostent     *host = NULL;  /* defined in winsock2.h */

	//double time_old, time_new, time_interval = 0;


	printf("======== Connect to PLC ========\n\n");

	/* Step 1: startup winsocket - this is for Windows only */
	/* in pair with WSACleanup()                    */
	if (WSAStartup(MAKEWORD(2, 2), &wsa_data) != 0)
	{
		puts("WSAStartup failed!");
		exit(1);
	}

	/* Step 2: Create socket and check it is successful */
	/* in pair with closesocket()               */
	HMI007 = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	if (HMI007 == INVALID_SOCKET)
	{
		printf("Failed to create socket(): %d\n", WSAGetLastError());
		exit(1);
	}

	/* Step 3.1: Setup TCP Server Parameters */
	HMI.sin_family = AF_INET;
	HMI.sin_addr.s_addr = inet_addr(MY_SERVER_IP_ADDRESS); /* defined in tcpserverclient.h */
	HMI.sin_port = htons(MY_SERVER_PORT_NUMBER);           /* defined in tcpserverclient.h */

														   /* Step 3.2: Connect to the TCP Server */
	if (connect(HMI007, (struct sockaddr *)&HMI, sizeof(HMI)) == SOCKET_ERROR)
	{
		printf("connect() failed: %d\n", WSAGetLastError());
		exit(1);
	}

	/* Step 4: Listen */
	listen(HMI007, 8);
	/*preparation */

	// Register session
	//byte Rgsession[] = { 0x65, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x44, 0x56, 0x41, 0x4e, 0x43, 0x45, 0x44, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00 };
	sendMessageStr[100] = RegSession();
	sendStatus = send(HMI007, sendMessageStr, 28, 0);
	// Receive session number
	recvStatus = recv(HMI007, recvBuffer, 128, 0);
	// Store session number
	SN1 = recvBuffer[4];
	SN2 = recvBuffer[5];
	SN3 = recvBuffer[6];
	SN4 = recvBuffer[7];

	byte connetionmanager[] = {0x6f, 0x00, 0x40, 0x00, SN1, SN2, SN3, SN4, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb2, 0x00, 0x30, 0x00, 0x54, 0x02, 0x20, 0x06, 0x24, 0x01, 0x07, 0xc3, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x41, 0x52, 0x43, 0x48, 0x49, 0x45, 0x02, 0x00, 0x00, 0x00, 0x80, 0x84, 0x1e, 0x00, 0xfc, 0x43, 0x80, 0x84, 0x1e, 0x00, 0xfc, 0x43, 0xa3, 0x03, 0x01, 0x00, 0x20, 0x02, 0x24, 0x01 };
	sendStatus = send(HMI007, connetionmanager, 88, 0);


	for (;;)
	{
		if (kbhit())				// if any input from the keyboard
		{
			input = getch();
			switch (input)
			{
			case 88: CrossTrack();
				break;
			case 120: CrossTrack();
				break;
			default: break;
			}
		}
	
		byte sendMessageStr1[] = {	0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
									0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
									0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x80, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
									0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/	
									0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x01 /*Specific Data*/ };
		
		sendStatus = send(HMI007, sendMessageStr1, 67, 0);
		if (sendStatus == 0)
			break;
		else if (sendStatus == SOCKET_ERROR)
		{
			printf("Failed to send(): %d\n", WSAGetLastError());
			break;
		}
		Sleep(500);

		byte sendMessageStr2[] = {	0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
									0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
									0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x81, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
									0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/
									0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x00 /*Specific Data*/ };
		sendStatus = send(HMI007, sendMessageStr2, 67, 0);
		if (sendStatus == 0)
			break;
		else if (sendStatus == SOCKET_ERROR)
		{
			printf("Failed to send(): %d\n", WSAGetLastError());
			break;
		}
		Sleep(2500);

		byte sendMessageStr3[] = {	0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
									0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
									0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x82, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
									0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/
									0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x00 /*Specific Data*/ };
		sendStatus = send(HMI007, sendMessageStr3, 67, 0);
		if (sendStatus == 0)
			break;
		else if (sendStatus == SOCKET_ERROR)
		{
			printf("Failed to send(): %d\n", WSAGetLastError());
			break;
		}

		Sleep(3000);
		
	}

	return 0;
}


// ask for session traffic
//0x65, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x44, 0x56, 0x41, 0x4e, 0x43, 0x45, 0x44, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00

//EN/IP packet sample
/*byte sendMessageStr[100] = {0x70, 0x00, 0x2b, 0x00, 0x00, 0x02, 0x02, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
0xa1, 0x00, 0x04, 0x00, 0x41, 0x01, 0x90, 0x02, 0xb1, 0x00, 0x17, 0x00, 0x80, 0x1a, 0x4d, 0x07,
0x91, 0x0b, 0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x31, 0x5f, 0x33, 0x00, 0xc1, 0x00,
0x01, 0x00, 0x01 };	*/

void CrossTrack(void)
{
	byte sendMessageStr1[] = { 0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
		0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x80, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
		0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/
		0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x01 /*Specific Data*/ };

	sendStatus = send(HMI007, sendMessageStr1, 67, 0);

	Sleep(500);

	byte sendMessageStr2[] = { 0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
		0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x81, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
		0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/
		0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x00 /*Specific Data*/ };
	sendStatus = send(HMI007, sendMessageStr2, 67, 0);

	Sleep(2500);

	byte sendMessageStr3[] = { 0x70, 0x00,	/*Send Unit Data*/		0x2b, 0x00,/*data length*/		  SN1, SN2, SN3, SN4,  /*session handle*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xa1, 0x00, 0x04, 0x00,
		0x41, 0x04, 0xa0, 0x02,	/*Connection ID*/	0xb1, 0x00,		0x17, 0x00,	/*CIP length*/		0x82, 0xfa,	/*Sequence Count*/	 0x4d, /*Unknown service*/
		0x07, /*Request Path Size*/		0x91, /*ANSI Symbol Segment*/	 0x0b,	/*Data Size*/
		0x54, 0x75, 0x72, 0x6e, 0x6f, 0x75, 0x74, 0x5f, 0x36, 0x5f, 0x33, /*Turnout_6_3*/	0x00,		0xc1, 0x00, 0x01, 0x00, 0x00 /*Specific Data*/ };
	sendStatus = send(HMI007, sendMessageStr3, 67, 0);

}